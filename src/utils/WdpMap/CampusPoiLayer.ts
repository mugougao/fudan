import { centroid } from "@turf/turf";
import to from "await-to-js";
import get from "lodash/get";
import { getCampus } from "@/api/commons";
import { campusNameToId } from "@/enums";
import PoiLayer from "./code/PoiLayer.ts";

interface ICampusPoiLayerData {
  mc: string;
  Id: number;
  mj: string;
}

class CampusPoiLayer extends PoiLayer<ICampusPoiLayerData> {
  readonly layerId: string = "CampusPoiLayer";
  readonly layerName: string = "校区中心点Poi图层";

  async fetchData() {
    // const [err, res] = await to(getCampus());
    // if (err) {
    //    //window.$message.error("校区区域数据获取失败!!!");
    //   return;
    // }
    // if (!res?.resultData) {
    //    window.$message.warning("暂无校区区域数据!!!");
    //   return;
    // }
    let res = {
      "type": "FeatureCollection",
      "name": "xiaoqu",
      "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
      "features": [
        { "type": "Feature", "properties": { "Id": 0, "mc": "张江校区", "mj": "350亩", "jj": "0.280476464923154", "sid": "2" }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[121.590473763817613, 31.193520946928459], [121.592903669396833, 31.194023489092956], [121.595287889324595, 31.194351854711726], [121.59643241006836, 31.194430376924856], [121.596753637304118, 31.189481098032672], [121.596111182832601, 31.188291367529757], [121.594540738568753, 31.188053421429288], [121.593291521540777, 31.190849288111053], [121.591150006635417, 31.190397190520059], [121.590473763817613, 31.193520946928459]]]] } },
        { "type": "Feature", "properties": { "Id": 0, "mc": "枫林校区", "mj": "288亩", "jj": "0.170793017873423", "sid": "1" }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[121.447289655292479, 31.193368201904377], [121.447016017276724, 31.193270049137936], [121.44695653075155, 31.193335484315526], [121.446682892736021, 31.193255177506501], [121.4465460737282, 31.193650762898869], [121.447090375433163, 31.19379650488537], [121.447289655292479, 31.193368201904377]]], [[[121.453604437454715, 31.19575034971831], [121.452384963689042, 31.195292303474503], [121.451748457870167, 31.196702134120528], [121.452414706951799, 31.196963874831226], [121.452718088229972, 31.196963874831226], [121.453116647948377, 31.196910336958581], [121.453098801990905, 31.196505828587647], [121.453271312913785, 31.196369009579769], [121.453604437454715, 31.19575034971831]]], [[[121.44845358607904, 31.198867091362956], [121.448758157087809, 31.198781430766871], [121.44891932591338, 31.198316642717032], [121.449412474576775, 31.197338299401338], [121.448867612293952, 31.197072977764492], [121.448591594817344, 31.197130084828643], [121.44845358607904, 31.197077736686651], [121.448077631240039, 31.198148494139105], [121.448039559864014, 31.198338851019628], [121.448153773992317, 31.198424511615883], [121.448049077708106, 31.1986910112484], [121.446811757985188, 31.198281743955476], [121.446683267090748, 31.198448306225941], [121.446488151288122, 31.198814743220794], [121.44626448195379, 31.19870528801448], [121.446678508168702, 31.198000967556879], [121.447259096654193, 31.197149120516713], [121.447644569337172, 31.19661136232935], [121.447687399635242, 31.196501907123036], [121.447672438947052, 31.196428599750448], [121.447280018361766, 31.196208461373374], [121.447130605759867, 31.196449558981044], [121.446811699477507, 31.196355273645452], [121.446335865783908, 31.197168156204896], [121.443984958310239, 31.196273478866658], [121.44380887819591, 31.196635156939578], [121.44368038730147, 31.196677987237649], [121.443223530788146, 31.197748744690273], [121.442828540261189, 31.198629145262487], [121.443242566476442, 31.198781430766871], [121.443751771131701, 31.198886127051026], [121.444308565007304, 31.19902413578933], [121.444736867988127, 31.199109796385642], [121.445298420785207, 31.199209733747864], [121.445579197184202, 31.199295394343949], [121.44607412507321, 31.199500027990553], [121.446026535853434, 31.199994955879788], [121.447991970644125, 31.200646928195397], [121.448215639978343, 31.200137723540081], [121.447901551125824, 31.200052062943939], [121.448382202248808, 31.198900403817106], [121.44845358607904, 31.198867091362956]]]] } },
        { "type": "Feature", "properties": { "Id": 0, "mc": "江湾校区", "mj": "1600亩", "jj": "1.02991523553277", "sid": "4" }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[121.491669070610442, 31.335985780414603], [121.493139577512125, 31.337670438806754], [121.496466063998355, 31.336000057180684], [121.497722419409342, 31.338198679149968], [121.498693239499858, 31.339497864859197], [121.499321417205238, 31.340268810225041], [121.499863934314703, 31.341139692953107], [121.500249406997568, 31.342039129213333], [121.50107745942762, 31.343138440198175], [121.502505136031004, 31.344880205654306], [121.503704384378011, 31.344194920884775], [121.505703131622909, 31.343338314922562], [121.509029618109025, 31.342396048364321], [121.508701252490255, 31.341011202058951], [121.50817301214704, 31.340026105202412], [121.506488353754889, 31.338113018553827], [121.504960739789226, 31.336756725780447], [121.503547339951751, 31.335143451218528], [121.502433752201, 31.333258918101933], [121.501448655344461, 31.333558730188543], [121.501048905895459, 31.333001936313224], [121.500178023167337, 31.332659293928316], [121.494667191477902, 31.33283061512077], [121.49535247624749, 31.334229738192221], [121.491669070610442, 31.335985780414603]]]] } },
        { "type": "Feature", "properties": { "Id": 0, "mc": "邯郸校区", "mj": "1383亩", "jj": "1.28223781263433", "sid": "3" }, "geometry": { "type": "MultiPolygon", "coordinates": [[[[121.49079872714502, 31.304975714931491], [121.494688848457017, 31.303761892385896], [121.494324790923187, 31.303162268212279], [121.493967871772256, 31.302869594508739], [121.4934753233441, 31.302598335954062], [121.493810827345882, 31.302091510759826], [121.494053532368397, 31.302112925908748], [121.494631741392809, 31.301441917905127], [121.501306129514191, 31.303847552982038], [121.501506004238749, 31.303262205574672], [121.501834369857519, 31.303333589404904], [121.502505377861198, 31.303676231789584], [121.505246516939778, 31.304539976134809], [121.505524913877466, 31.30385469136505], [121.504511263489107, 31.30356915604435], [121.504868182639811, 31.302898148040729], [121.505774757283106, 31.303233652042511], [121.506281582477399, 31.301941604716351], [121.505674819920941, 31.301741729991907], [121.50591752494357, 31.301134967435448], [121.506188783498246, 31.301163520967439], [121.506388658222576, 31.300706664454456], [121.503197801013798, 31.299593076703534], [121.504411326126714, 31.297630021373866], [121.504896736171972, 31.296880491157001], [121.503140693949589, 31.295524198383621], [121.50353330501558, 31.295252939828945], [121.504418464509726, 31.294867467146023], [121.502890850544063, 31.292783059305041], [121.501698740580068, 31.291119816061983], [121.503169247481637, 31.290527330271434], [121.502769498032748, 31.289863460650825], [121.502027106199066, 31.290184687886583], [121.502319779902663, 31.290798588826053], [121.501598803217902, 31.291041293848739], [121.501256160832995, 31.290527330271434], [121.500213956912589, 31.290791450443042], [121.49982848422961, 31.291076985763741], [121.499699993335284, 31.291305414020346], [121.49989272967683, 31.291855069512653], [121.499021846948594, 31.292254818961656], [121.497850795214603, 31.291317549271501], [121.497750857852324, 31.291278288164822], [121.497418923042105, 31.291510285612876], [121.495873463118855, 31.292552489533566], [121.494820551623761, 31.292891562726911], [121.494410094600184, 31.293030761195698], [121.494438648132345, 31.293244912686166], [121.494720614261368, 31.293244912686166], [121.494809844049072, 31.293573278304937], [121.494906212219902, 31.293801706561542], [121.495013287965307, 31.293987304520019], [121.495163194008441, 31.294008719669169], [121.495277408136744, 31.29425499388319], [121.495463006095278, 31.29428354741535], [121.495505836393349, 31.2946940044387], [121.495156055625429, 31.294826064524589], [121.495127502093382, 31.29493314026988], [121.495202455115177, 31.295036646823608], [121.495280977328306, 31.295190122058418], [121.495535960369565, 31.295287204067538], [121.495800080541343, 31.295360015574179], [121.496221245139267, 31.295441393140752], [121.496910366789834, 31.295629132613985], [121.49685088026466, 31.295926565239856], [121.49688954650604, 31.29595630850233], [121.497166158848117, 31.295977128786124], [121.497189953458005, 31.295944411197272], [121.49734759274962, 31.296024718006297], [121.497225645373177, 31.296226972191821], [121.497249439983179, 31.2963756885047], [121.496725958562124, 31.297443471630945], [121.496496935440049, 31.297803365108084], [121.495348845504722, 31.297544598723764], [121.495051412879079, 31.297482137872382], [121.495158488624256, 31.297773621845497], [121.494346497556293, 31.29815433560643], [121.492802822228654, 31.301006714487276], [121.491752885059654, 31.30120004569395], [121.491325581246187, 31.30118366382013], [121.491050753499835, 31.301195561125187], [121.491087635145604, 31.301390676927586], [121.489986135263038, 31.301565887823561], [121.490087262355686, 31.301955524563287], [121.489480499799228, 31.302047728677312], [121.49079872714502, 31.304975714931491]]]] } },
      ]
    }

    const features = res.features;
    const result: any = features.map((item: any) => {
      const geojson = { features: [item], type: "FeatureCollection" } as any;
      const [x, y] = get(centroid(geojson), "geometry.coordinates", []);
      const name = get(item, "properties.mc", "");
      const id = campusNameToId(name);
      return {
        id,
        name,
        location: [x, y, 0],
        data: item.properties as ICampusPoiLayerData,
      };
    });
    console.warn(result);
    this.setData(result);
  }

  render() {
    const list = Array.from(this.layerDataMap.values());
    return this.add(list, "campus");
  }

  async onCreate() {
    await this.fetchData();
    return await this.render();
  }

  onUnmount(): any {
  }
}

export default new CampusPoiLayer();
